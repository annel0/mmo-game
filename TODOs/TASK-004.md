# TASK-004: Spatial Index и поточная обработка регионов

## Описание
Реализовать пространственный индекс и систему регионов для эффективной обработки большого количества игроков (до 5000) путём распараллеливания обновлений по регионам.

## Реализация ✅

### 1. Пространственный индекс (spatial_index.go)
Реализован hash-grid индекс для быстрого поиска сущностей:
- **Структура**: Сетка ячеек размером 16x16 (размер чанка)
- **Операции**: O(1) вставка/удаление, O(k) поиск в радиусе (k - количество ячеек)
- **Потокобезопасность**: RWMutex для каждой ячейки
- **Функции**:
  - `Insert/Update/Remove` - управление сущностями
  - `QueryRange` - поиск в радиусе
  - `QueryRect` - поиск в прямоугольнике
  - `GetNearbyEntities` - удобный метод для поиска соседей

### 2. Менеджер регионов (region_manager.go)
Система разделения мира на регионы для параллельной обработки:
- **Размер региона**: 4x4 чанка (64x64 блока) по умолчанию
- **Воркеры**: По умолчанию = количество CPU ядер
- **Обновление**: 20 Hz (50ms между тиками)
- **Функции**:
  - Автоматическое создание/удаление регионов
  - Перемещение сущностей между регионами
  - Параллельное обновление регионов
  - Сбор статистики производительности

### 3. Преимущества реализации
- **Масштабируемость**: Линейное масштабирование с количеством ядер
- **Локальность данных**: Сущности в одном регионе обрабатываются вместе
- **Минимальные блокировки**: Регионы обновляются независимо
- **Эффективный поиск**: O(1) для определения региона, быстрый поиск соседей

## Интеграция

Для интеграции с WorldManager необходимо:
1. Заменить прямые map[string]*Entity на RegionManager
2. Использовать SpatialIndex для поиска сущностей в радиусе
3. Вызывать RegionManager.Start() при запуске сервера
4. Обновить методы AddEntity/RemoveEntity/MoveEntity

## Статистика

RegionManager собирает следующую статистику:
- Количество активных регионов
- Общее количество сущностей
- Количество обновлений в секунду
- Среднее время обновления региона

## Файлы
- `internal/world/spatial_index.go` - пространственный индекс
- `internal/world/region_manager.go` - менеджер регионов

## Статус
✅ Done (2025-06-20)

## История изменений
- 2025-06-20: Задача создана
- 2025-06-20: Реализован spatial index с hash-grid
- 2025-06-20: Реализован region manager с воркер-пулом
- 2025-06-20: Задача завершена 