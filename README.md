# 2D-мир на Go

Сервер игрового 2D-мира, реализованный на языке Go.

## Архитектура проекта

Проект представляет собой сервер для симуляции 2D-мира с блоками, сущностями и их взаимодействиями.

### Основные компоненты

- **WorldManager** - центральный компонент, управляющий всем миром
- **BigChunk** - единица симуляции, содержащая 32x32 чанков
- **Chunk** - участок мира размером 16x16 блоков
- **Block** - отдельный блок с ID и метаданными (payload)
- **BlockBehavior** - интерфейс, определяющий поведение блока
- **BlockAPI** - API для взаимодействия блоков с миром
- **Event** - система событий для взаимодействия компонентов

### Иерархия мира

```
WorldManager
└── BigChunk (32x32 чанков)
    └── Chunk (16x16 блоков)
        └── Block (1x1)
```

## Компоненты

### Vec2

Представляет 2D координаты и содержит методы для конвертации координат:
- `ToChunkCoords` - преобразует глобальные координаты в координаты чанка
- `ToBigChunkCoords` - преобразует в координаты BigChunk
- `LocalInChunk` - возвращает локальные координаты внутри чанка

### Block

Представляет блок в игровом мире:
- `ID` - идентификатор типа блока
- `Payload` - метаданные блока (состояние)

### BlockBehavior

Интерфейс, определяющий поведение блока:
- `ID()` - возвращает идентификатор блока
- `Name()` - возвращает имя блока
- `NeedsTick()` - определяет, требует ли блок обновления в тиках
- `TickUpdate()` - обновляет состояние блока при тике
- `OnPlace()` - вызывается при установке блока
- `OnBreak()` - вызывается при разрушении блока
- `CreateMetadata()` - создает начальные метаданные

### BlockAPI

Интерфейс для взаимодействия блоков с миром:
- `GetBlockID()` - получает ID блока по координатам
- `SetBlock()` - устанавливает блок по координатам
- `GetBlockMetadata()` - получает метаданные блока
- `SetBlockMetadata()` - устанавливает метаданные блока
- `GetBlockIDLayer()` / `SetBlockLayer()` – работа с конкретным слоем (FLOOR, ACTIVE и др.)
- `ScheduleUpdateOnce()` – помечает блок для **разового** обновления в следующем тике
- `TriggerNeighborUpdates()` – планирует разовое обновление для четырёх соседних блоков

### Chunk

Хранит матрицу блоков **в трёх измерениях** (`Blocks3D[layer][x][y]`) и их метаданные:
- `Blocks3D` – трёхмерный массив ID блоков (до 4 слоёв)
- `Metadata3D` – карта метаданных, индексируемая `BlockCoord{Layer, Pos}`
- `Tickable3D` – тикаемые блоки (постоянное обновление)
- `Changes3D` – изменённые блоки (для отправки дельт)

### BigChunk

Единица симуляции, которая содержит 32x32 чанка:
- Имеет собственную горутину
- Обрабатывает события блоков и сущностей
- Управляет тиками для блоков и сущностей

### WorldManager

Центральный компонент, координирующий мир:
- Управляет активными BigChunk'ами
- Маршрутизирует события
- Обрабатывает тики и сохранения

### Система событий

Позволяет компонентам взаимодействовать друг с другом:
- `BlockEvent` - события блоков (изменение, взаимодействие)
- `EntityEvent` - события сущностей (перемещение, спавн)
- `TickEvent` - игровой тик
- `SaveEvent` - сохранение состояния

## Хранение данных

Для хранения используется BadgerDB, которая сохраняет состояния чанков:
- Сохраняются только измененные блоки
- Метаданные сериализуются в JSON

## Запуск проекта

```bash
go run cmd/server/main.go
```

## Запуск тестов

```bash
go test ./...
```

### Двухслойная генерация (обновление 2025-06-16)

1. **LayerFloor** – базовый слой (земля, песок, камень, вода, **глубинная вода**).
2. **LayerActive** – верхний слой с объектами взаимодействия (трава, деревья, руды).

Константы высот:
```
DeepWaterMax    = 0.20 // Глубинная вода, статична
ShallowWaterMax = 0.30 // Мелководье, обычная вода
ActiveStart     = 0.60 // Выше — активные блоки (деревья и др.)
MountainStart   = 0.80 // Горы, возможны руды
```

### Система UpdateOnce

Чтобы избежать лишних вычислений, внедрена система **разовых обновлений**:
1. Блок вызывает `ScheduleUpdateOnce(pos)` (или `TriggerNeighborUpdates`) при изменении.
2. BigChunk помещает координату в `onceTickables`.
3. В следующем тике метод `TickUpdate` блока вызывается ровно **один** раз.

Пример использования:
```go
func (b *WaterBehavior) OnBreak(api block.BlockAPI, pos vec.Vec2) {
    // Если игрок вычерпнул воду – обновим соседей, чтобы глубинная вода превратилась в обычную
    api.TriggerNeighborUpdates(pos)
}
```

### Новые блоки

| ID | Блок            | Особенности               |
|----|-----------------|---------------------------|
| 6  | DeepWater       | Статичная «глубинная» вода|

Глубинная вода превращается в обычную, если рядом появляется воздух/суша. 