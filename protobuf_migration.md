# Миграция на Protocol Buffers

## Введение

Данный документ описывает основные этапы и результаты перехода сетевого протокола игры с JSON на Protocol Buffers. 

## Преимущества Protocol Buffers

1. **Производительность**:
   - Сокращение размера передаваемых данных на 60-80% по сравнению с JSON
   - Ускорение сериализации/десериализации в 20-100 раз
   - Снижение нагрузки на процессор и сеть

2. **Строгая типизация**:
   - Статическая проверка типов на этапе компиляции
   - Меньше ошибок при работе с данными
   - Автоматическая генерация кода

3. **Обратная совместимость**:
   - Возможность добавления новых полей без нарушения работы существующих клиентов
   - Четкая версионность протокола

4. **Двоичный формат**:
   - Компактное представление данных
   - Эффективная передача по сети

## Архитектура нового протокола

Протокол основан на следующих ключевых компонентах:

1. **GameMessage** - базовое сообщение, содержащее:
   - Тип сообщения (MessageType)
   - Полезную нагрузку (Payload)

2. **Типы сообщений**:
   - Авторизация и базовые взаимодействия (AUTH, AUTH_RESPONSE, PING, PONG)
   - Обработка блоков и чанков (BLOCK_UPDATE, CHUNK_DATA)
   - Управление сущностями (ENTITY_SPAWN, ENTITY_MOVE)
   - Чат (CHAT, CHAT_BROADCAST)

3. **Сериализаторы**:
   - MessageSerializer - основной компонент для сериализации/десериализации

4. **Сетевые обработчики**:
   - TCPServerPB - обработка TCP-соединений
   - UDPServerPB - обработка UDP-пакетов
   - GameHandlerPB - общая логика игры

## Основные этапы миграции

1. **Определение структуры .proto файлов**:
   - Создание common.proto для общих типов
   - Создание специализированных типов для конкретных доменов (auth.proto, block.proto, entity.proto)

2. **Разработка сериализаторов**:
   - Создание классов для работы с Protocol Buffers

3. **Обновление сетевой инфраструктуры**:
   - Создание новых серверов с поддержкой Protocol Buffers
   - Оптимизация передачи данных

4. **Интеграция с игровой логикой**:
   - Обновление обработчиков сообщений
   - Поддержка JSON-метаданных внутри Protocol Buffers

## Технические детали реализации

### Структура сообщения

```
GameMessage:
  - Type: int32 (тип сообщения)
  - Payload: bytes (сериализованные данные)
```

### Формат заголовка TCP-пакета

```
[0-3] - Размер сообщения (uint32, big-endian)
[4+]  - Тело сообщения (GameMessage)
```

### Формат UDP-пакета

```
[0-7] - ID игрока (uint64, big-endian)
[8+]  - Тело сообщения (GameMessage)
```

## Рекомендации по использованию

1. **Обработка сообщений**:
   ```go
   // Десериализация сообщения
   msg, err := serializer.DeserializeMessage(data)
   if err != nil {
       // Обработка ошибки
   }

   // Обработка в зависимости от типа
   switch msg.Type {
   case protocol.MessageType_AUTH:
       // Десериализация полезной нагрузки
       authReq := &protocol.AuthRequest{}
       err := serializer.DeserializePayload(msg, authReq)
       // Обработка запроса
   case protocol.MessageType_ENTITY_MOVE:
       // ...
   }
   ```

2. **Отправка сообщений**:
   ```go
   // Создаем полезную нагрузку
   authResp := &protocol.AuthResponse{
       Success: true,
       PlayerId: playerID,
       // Другие поля
   }

   // Сериализуем и отправляем
   data, err := serializer.SerializeMessage(protocol.MessageType_AUTH_RESPONSE, authResp)
   if err != nil {
       // Обработка ошибки
   }
   // Отправка данных
   ```

## Заключение

Переход на Protocol Buffers значительно улучшил производительность и надежность сетевой части игры. Оптимизация размера пакетов позволила снизить нагрузку на сеть, а строгая типизация уменьшила количество ошибок при обработке данных. 

## Статус миграции (2025-06-05)

Все компоненты, использовавшие старый JSON-протокол, удалены из дерева исходников
(`internal/network/*` без суффикса `_pb.go`).  Сетевая подсистема полностью
работает на Protocol Buffers.  Инструкции по переходу клиентов:

1. Обновите SDK до последней версии, использующей `*.proto` из каталога
   `internal/protocol/proto`.
2. Удалите зависимости от JSON-структур – все сообщения передаются через
   `GameMessage`.
3. TCP-сервер слушает порт `:9090`, UDP – `:9091`; формат заголовков описан
   выше.

CI/CD: добавлен workflow `Build & Release`, автоматически публикующий
кросс-платформенные бинарники при создании тега `vX.Y.Z`.

Миграция считается **полностью завершённой**. 